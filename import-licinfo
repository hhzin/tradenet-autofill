// ==UserScript==
// @name         Tradenet Import License Information
// @namespace    http://tampermonkey.net/
// @version      1.2.0
// @description  Autofill Import Licence forms with saved profiles; add/delete profiles from popup UI (Tampermonkey storage).
// @author       uzi
// @updateURL    https://raw.githubusercontent.com/hhzin/tradenet-autofill/main/import-licinfo.js
// @downloadURL  https://raw.githubusercontent.com/hhzin/tradenet-autofill/main/import-licinfo.js
// @match        https://oversea.myanmartradenet.com/ImportLicence*
// @icon         https://www.google.com/s2/favicons?sz=64&domain=myanmartradenet.com
// @grant        GM_getValue
// @grant        GM_setValue
// @grant        GM_deleteValue
// @run-at       document-end
// ==/UserScript==

(function() {
    'use strict';

    /* ---------- Selector map for Import form ---------- */
    const SELECTOR_MAP = {
        autoRadioValue: { type: 'radio', selector: 'input[name="auto"]' },

        rbtnSea:  { type: 'checkbox', selector: '#rbtnSea' },
        rbtnRoad: { type: 'checkbox', selector: '#rbtnRoad' },
        rbtnAir:  { type: 'checkbox', selector: '#rbtnAir' },

        ExportImportSectionId: { type: 'select', selector: '#ExportImportSectionId' },
        SellerName:   { type: 'input', selector: '#SellerName' },
        SellerAddress:{ type: 'input', selector: '#SellerAddress' },
        SellerCountryId: { type: 'select', selector: '#SellerCountryId' },
        PortofDischargeCode: { type: 'select', selector: '#PortofDischargeCode' },

        ExportImportMethodId: { type: 'select', selector: '#ExportImportMethodId' },
        ExportImportIncotermId: { type: 'select', selector: '#ExportImportIncotermId' },

        CommodityType: { type: 'input', selector: '#CommodityType' },

        ConsignedCountryId: { type: 'multiselect', selector: '#ConsignedCountryId' },
        nonCountryofOriginId: { type: 'multiselect', selector: '#nonCountryofOriginId' }
    };

    const STORAGE_KEY = 'tn_import_profiles_v1';

    /* ---------- Storage helpers ---------- */
    function saveProfiles(obj) {
        GM_setValue(STORAGE_KEY, JSON.stringify(obj || {}));
    }
    function loadProfiles() {
        try { return JSON.parse(GM_getValue(STORAGE_KEY, '{}')); }
        catch { return {}; }
    }

    /* ---------- Utility ---------- */
    function waitForCondition(checkFn, timeout = 10000, interval = 200) {
        const start = Date.now();
        return new Promise((resolve, reject) => {
            (function loop() {
                try { if (checkFn()) return resolve(true); } catch {}
                if (Date.now() - start > timeout) return reject('timeout');
                setTimeout(loop, interval);
            })();
        });
    }

    function triggerChange(el) {
        if (!el) return;
        el.dispatchEvent(new Event("change", { bubbles: true }));
        if (window.$) {
            try { $(el).trigger("change").trigger("changed.bs.select"); } catch {}
        }
    }

    function refreshSelectpicker(sel) {
        if (window.$){
            try { $(sel).selectpicker("refresh"); } catch {}
        }
    }

    function setSelectValue(selector, val) {
        const el = document.querySelector(selector);
        if (!el) return false;
        for (const o of el.options) o.selected = false;
        const opt = el.querySelector(`option[value="${val}"]`);
        if (opt) opt.selected = true;
        refreshSelectpicker(selector);
        triggerChange(el);
        return !!opt;
    }

    function setMultiSelectValues(selector, values) {
        const el = document.querySelector(selector);
        if (!el) return;
        for (const o of el.options) o.selected = false;
        values.forEach(v => {
            const opt = el.querySelector(`option[value="${v}"]`);
            if (opt) opt.selected = true;
        });
        refreshSelectpicker(selector);
        triggerChange(el);
    }

    /* ---------- Read form ---------- */
    function readForm() {
        const out = {};
        for (const key in SELECTOR_MAP) {
            const info = SELECTOR_MAP[key];
            const sel = info.selector;
            const type = info.type;

            try {
                if (type === "input") {
                    out[key] = document.querySelector(sel)?.value || "";
                }
                else if (type === "select") {
                    out[key] = document.querySelector(sel)?.value || "";
                }
                else if (type === "checkbox") {
                    out[key] = !!document.querySelector(sel)?.checked;
                }
                else if (type === "radio") {
                    let chosen = null;
                    document.querySelectorAll(sel).forEach(r => {
                        if (r.checked) chosen = r.value;
                    });
                    out[key] = chosen;
                }
                else if (type === "multiselect") {
                    const el = document.querySelector(sel);
                    if (!el) out[key] = [];
                    else {
                        out[key] = [...el.options].filter(o => o.selected).map(o => o.value);
                    }
                }
            } catch {
                out[key] = (type === "multiselect") ? [] : "";
            }
        }
        return out;
    }

    /* ---------- Fill profile ---------- */
    async function fillProfile(p) {
        if (!p) return;

        if (p.autoRadioValue) {
            const r = document.querySelector(`input[name="auto"][value="${p.autoRadioValue}"]`);
            if (r) { r.checked = true; triggerChange(r); }
        }

        ['rbtnSea','rbtnRoad','rbtnAir'].forEach(key => {
            if (key in p) {
                const el = document.querySelector(SELECTOR_MAP[key].selector);
                if (el) { el.checked = !!p[key]; triggerChange(el); }
            }
        });

        if (p.ExportImportSectionId)
            setSelectValue('#ExportImportSectionId', p.ExportImportSectionId);

        if (p.SellerName) {
            const el = document.querySelector('#SellerName');
            if (el) { el.value = p.SellerName; triggerChange(el); }
        }
        if (p.SellerAddress) {
            const el = document.querySelector('#SellerAddress');
            if (el) { el.value = p.SellerAddress; triggerChange(el); }
        }

        if (p.SellerCountryId)
            setSelectValue('#SellerCountryId', p.SellerCountryId);

        if (p.PortofDischargeCode) {
            try {
                await waitForCondition(() => {
                    const el = document.querySelector('#PortofDischargeCode');
                    return el && el.querySelector(`option[value="${p.PortofDischargeCode}"]`);
                }, 8000);
            } catch {}
            setSelectValue('#PortofDischargeCode', p.PortofDischargeCode);
        }

        if (p.ExportImportMethodId)
            setSelectValue('#ExportImportMethodId', p.ExportImportMethodId);

        if (p.ExportImportIncotermId)
            setSelectValue('#ExportImportIncotermId', p.ExportImportIncotermId);

        if (p.CommodityType) {
            const el = document.querySelector('#CommodityType');
            if (el) { el.value = p.CommodityType; triggerChange(el); }
        }

        if (Array.isArray(p.ConsignedCountryId))
            setMultiSelectValues('#ConsignedCountryId', p.ConsignedCountryId);

        if (Array.isArray(p.nonCountryofOriginId))
            setMultiSelectValues('#nonCountryofOriginId', p.nonCountryofOriginId);

        await new Promise(r => setTimeout(r, 200));
    }

    /* ---------- Movable UI (same as Export UI) ---------- */
    function makePanelDraggable(panel, handle) {
        let active = false;
        let startX = 0, startY = 0;
        let startLeft = 0, startTop = 0;

        handle.addEventListener("pointerdown", e => {
            active = true;
            handle.setPointerCapture(e.pointerId);

            const rect = panel.getBoundingClientRect();
            startLeft = rect.left;
            startTop  = rect.top;

            panel.style.left = startLeft + "px";
            panel.style.top  = startTop + "px";
            panel.style.right = "auto";

            startX = e.clientX;
            startY = e.clientY;

            handle.style.cursor = "grabbing";
            e.preventDefault();
        });

        handle.addEventListener("pointermove", e => {
            if (!active) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            panel.style.left = (startLeft + dx) + "px";
            panel.style.top  = (startTop  + dy) + "px";
            panel.style.right = "auto";
        });

        handle.addEventListener("pointerup", e => {
            active = false;
            handle.style.cursor = "grab";
            try { handle.releasePointerCapture(e.pointerId); } catch {}
        });
    }

    /* ---------- UI PANEL (IDENTICAL TO EXPORT) ---------- */
    function createMenu() {
        const old = document.getElementById("autofillMenu");
        if (old) old.remove();

        const panel = document.createElement("div");
        panel.id = "autofillMenu";
        panel.style = `
            position: fixed;
            top: 110px;
            right: 60px;
            width: 300px;
            background: #ffffff;
            border: 1px solid #aaa;
            border-radius: 6px;
            padding: 0;
            z-index: 999999;
            font-family: Arial;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        `;

        panel.innerHTML = `
            <div id="autofillHeader" style="
                display:flex;
                align-items:center;
                justify-content:space-between;
                padding: 8px;
                background: #f0f0f0;
                border-bottom: 1px solid #ccc;
                cursor: grab;
                font-weight: bold;
            ">
                <div style="user-select:none;">Import Autofill</div>
            </div>

            <div id="autofillBody" style="padding: 12px;">
                <div style="display:flex; gap:6px; margin-bottom:8px;">
                    <select id="templateSelect" style="flex:1; padding:6px;">
                        <option value="">Choose profile...</option>
                    </select>
                    <button id="runTemplate" style="padding:6px;">Fill</button>
                </div>

                <div style="display:flex; gap:6px; margin-bottom:8px;">
                    <button id="btnAddProfile" style="flex:1; padding:6px;">Add Profile</button>
                    <button id="btnDeleteProfile" style="flex:1; padding:6px;">Delete</button>
                </div>

                <div id="autofillMessage" style="margin-top:8px; font-size:12px; color:#444;"></div>
            </div>
        `;

        document.body.appendChild(panel);

        makePanelDraggable(panel, panel.querySelector("#autofillHeader"));
        populateDropdown();

        document.getElementById("runTemplate").addEventListener("click", async () => {
            const name = document.getElementById("templateSelect").value;
            if (!name) return showMessage("Pick a profile first.");
            const profiles = loadProfiles();
            if (!profiles[name]) return showMessage("Not found.");
            showMessage("Applying " + name + " ...");
            await fillProfile(profiles[name]);
            showMessage("Done.");
        });

        document.getElementById("btnAddProfile").addEventListener("click", () => {
            const snapshot = readForm();
            const label = prompt("Name this profile:");
            if (!label) return;
            const profiles = loadProfiles();
            profiles[label] = snapshot;
            saveProfiles(profiles);
            populateDropdown();
            showMessage("Saved: " + label);
        });

        document.getElementById("btnDeleteProfile").addEventListener("click", async () => {
            const profiles = loadProfiles();
            const names = Object.keys(profiles);
            if (!names.length) {
                alert("No profiles saved.");
                return;
            }

            const pick = await chooseProfileToDelete(profiles);
            if (!pick) return; // cancelled

            if (!profiles[pick]) {
                alert("Profile not found.");
                return;
            }

            delete profiles[pick];
            saveProfiles(profiles);
            populateDropdown();
            showMessage("Deleted: " + pick);
        });
    }

    function populateDropdown() {
        const sel = document.getElementById('templateSelect');
        if (!sel) return;
        sel.innerHTML = `<option value="">Choose profile...</option>`;
        const profiles = loadProfiles();
        Object.keys(profiles).forEach(name => {
            const op = document.createElement('option');
            op.value = name;
            op.textContent = name;
            sel.appendChild(op);
        });
    }

    function showMessage(msg) {
        const el = document.getElementById('autofillMessage');
        if (el) el.textContent = msg;
    }

    function isVisible(el) {
        if (!el) return false;
        const rect = el.getBoundingClientRect();
        const style = window.getComputedStyle(el);
        return (
            rect.width > 0 &&
            rect.height > 0 &&
            style.display !== "none" &&
            style.visibility !== "hidden"
        );
    }

    function toggleAutofillPanelVisibility() {
        const panel = document.getElementById("autofillMenu");
        if (!panel) return;

        // Only visible on the *main form* where auto radio is visible
        const autoRadio = document.querySelector('input[name="auto"]');

        if (isVisible(autoRadio)) {
            panel.style.display = "block";
        } else {
            panel.style.display = "none";
        }
    }

    function chooseProfileToDelete(profiles) {
        return new Promise(resolve => {
            // Build popup container
            const wrapper = document.createElement("div");
            wrapper.style = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #888;
            padding: 16px;
            z-index: 999999999;
            width: 260px;
            border-radius: 6px;
            font-family: Arial;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        `;

            wrapper.innerHTML = `
            <div style="margin-bottom:8px; font-weight:bold;">Delete Profile</div>
            <select id="deleteProfileSelect" style="width:100%; padding:6px; margin-bottom:12px;">
                <option value="">Choose profile...</option>
                ${Object.keys(profiles).map(p => `<option>${p}</option>`).join("")}
            </select>
            <div style="display:flex; justify-content:space-between;">
                <button id="delCancel" style="padding:6px 10px;">Cancel</button>
                <button id="delConfirm" style="padding:6px 10px;">Delete</button>
            </div>
        `;

            document.body.appendChild(wrapper);

            wrapper.querySelector("#delCancel").onclick = () => {
                wrapper.remove();
                resolve(null);
            };

            wrapper.querySelector("#delConfirm").onclick = () => {
                const select = wrapper.querySelector("#deleteProfileSelect").value;
                wrapper.remove();
                resolve(select || null);
            };
        });
    }



    /* ---------- Init ---------- */
    createMenu();
    populateDropdown();
    toggleAutofillPanelVisibility();

    setInterval(toggleAutofillPanelVisibility, 500);

})();
